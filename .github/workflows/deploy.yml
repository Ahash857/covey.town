name: Deploy to Lightsail

on:
  push:
    branches: [ emotes ]   # âœ… deploy when emotes updates

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Write SSH key to file
        run: |
          mkdir -p ~/.ssh
          # write the secret exactly as-is; keep permissions strict
          printf '%s' "${{ secrets.SSH_KEY }}" > ~/.ssh/gha_deploy
          chmod 600 ~/.ssh/gha_deploy
      - name: Deploy via SSH to Lightsail
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key_path: ~/.ssh/gha_deploy
          script: |
            set -e
            cd ${{ secrets.PROJECT_DIR }}

            # Pull latest emotes branch
            BRANCH="emotes"
            git fetch --all --prune
            git checkout "$BRANCH" || git checkout -b "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # Backend
            cd townService
            nvm use 18.0.0 || true
            npm ci
            npm run build

            # Frontend
            cd ../frontend
            export NEXT_PUBLIC_TOWNS_SERVICE_URL='${{ secrets.NEXT_PUBLIC_TOWNS_SERVICE_URL }}'
            npm ci
            npm run build

            # Restart PM2 services by name
            pm2 restart covey-backend
            pm2 restart covey-frontend
            pm2 save
